## APK 打包流程组成

Android 的打包流程如下：

![image](https://upload-images.jianshu.io/upload_images/22650779-b26f20f7247895f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

主要流程是：资源文件、Java -> DEX -> APK

*   **资源文件**：Android 项目中的 `res` 目录下的资源文件（如布局、图片、字符串等）。
*   **Java -> DEX**：将 Java 代码编译为 `.class` 文件，然后通过 `dx` 工具或 `d8` 工具转换为 `.dex`（Dalvik Executable）文件。
*   **APK**：将所有文件打包成最终的 APK 文件，并签名。

如果要减少 APK 的大小，可以通过以下方式进行优化：

*   **减少打包前的文件**：如去除无用和重复的资源、代码。
*   **压缩打包中的文件**：例如对资源文件、Dex 文件、So 文件进行压缩。

* * *

## APK 组成部分解压分析

解压 APK 后，我们可以看到它由以下几个部分组成：

![image](https://upload-images.jianshu.io/upload_images/22650779-d3b6471cce16f581.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

*   **res**：编译后的资源文件，包括 `drawable`、`layout`、`mipmap`、`raw` 等文件夹。
*   **assets**：用于存放字体文件、配置文件、视频等文件，存储的是原始数据，不会被编译。
*   **lib**：包含不同平台的 `.so` 文件（共享库），例如针对不同架构的 `armeabi-v7a`、`x86` 等文件夹。
*   **classes(n).dex**：编译后的 Java 文件，通过 `dx` 或 `d8` 工具转化为 `.dex` 文件，供 Dalvik 或 ART 虚拟机运行。
*   **kotlin**：编译后的 Kotlin 文件，通常会打包为 `.klib` 文件。
*   **META-INF**：存放签名信息，主要包括证书、签名文件等。
*   **AndroidManifest.xml**：应用的配置文件，定义了应用的组件、权限、特性等。

* * *

## 如何优化 APK 包体积

### 1\. 减少无用文件和资源

#### 1.1 去除无用和重复的资源

在开发过程中，可能会不小心加入一些未使用的资源（如图片、布局文件等），这些文件并不会在最终的应用中被使用，但会占用 APK 的空间。可以通过以下方式减少 APK 大小：

*   **使用 `LINT` 工具检测无用资源**：使用 Android Studio 提供的 `Lint` 工具，可以检查并移除项目中的未使用资源。
*   **去除重复资源**：在 `res` 目录下，可能会有一些相似或重复的图片文件，可以通过工具（如 `Android Image Optimizer` 或 `ImageOptim`）查找和去除这些重复的图片资源。

#### 1.2 移除无用的代码

*   **Proguard 混淆和优化**：开启 Proguard 或 R8 来移除未使用的代码（类、方法、字段等）。这不仅可以减小 APK 大小，还能提高代码的安全性。
*   **移除不必要的库**：有时我们会引入一些额外的第三方库，但并不一定会使用到。可以通过 `dependencies` 来移除这些库，或使用更小的替代库。

#### 1.3 使用 `VectorDrawable` 替代 `PNG`

对于一些简单的图标和图片，可以考虑使用 `VectorDrawable` 替代 `.png` 或 `.jpg` 格式的图片文件。`VectorDrawable` 是矢量图，可以根据设备的分辨率进行缩放，不会增加额外的体积。

* * *

### 2\. 压缩资源文件

#### 2.1 压缩图片资源

图片资源通常是 APK 大小的主要组成部分。对图片进行压缩可以显著减小 APK 的体积。常见的压缩方式包括：

*   **使用 WebP 格式**：WebP 是 Google 推出的高效图片格式，具有较小的文件大小和较好的压缩质量。可以通过 Android Studio 中的转换工具将 PNG 或 JPEG 格式的图片转换为 WebP 格式。
*   **压缩 PNG/JPEG 图片**：使用如 `pngcrush` 或 `jpegoptim` 等工具来压缩图片文件，去除冗余信息，进一步减小文件体积。
*   **图像尺寸调整**：确保不使用过大尺寸的图片，可以在不同的 `dpi` 目录下使用适合的图片尺寸，以避免因不必要的大图片占用空间。

#### 2.2 压缩 DEX 文件

DEX 文件是 Android APK 中非常重要的一部分。如果 APK 中的 DEX 文件过大，可以采用以下方式压缩：

*   **MultiDex 支持**：开启 MultiDex 支持将应用的 DEX 文件分为多个部分。这样可以避免主 DEX 文件过大导致的 APK 大小问题。
*   **Proguard 或 R8 优化**：通过 Proguard 或 R8 优化 DEX 文件，移除未使用的类和方法，从而减小 DEX 文件的体积。

#### 2.3 压缩 `so` 文件

`so` 文件通常是为原生代码提供支持的动态库。为了减小 APK 的体积，可以采取以下措施：

*   **使用瘦版本的 So 文件**：根据不同的架构（如 `armeabi-v7a`、`x86` 等）提供相应的 `.so` 文件，避免包含不必要的架构版本。
*   **使用 `strip` 工具**：通过 `strip` 工具去除 So 文件中的调试符号，从而减小文件体积。

* * *

### 3\. 其他优化策略

#### 3.1 开启 APK 分包

通过 `App Bundles`（`.aab` 格式）来代替传统的 APK 打包方式。`App Bundles` 可以根据设备的具体配置（如 CPU 架构、屏幕分辨率等）动态生成 APK，从而实现按需下载资源和代码，避免了包含冗余资源的 APK 文件。

#### 3.2 使用动态特性模块

通过 Android 的 **Dynamic Delivery**，可以将应用的不同模块按需下载，用户只下载他们需要的部分，从而减小初始下载体积。

* * *

## 总结

优化 APK 大小是提高应用性能、用户体验以及下载速度的重要环节。通过减少无用的资源、压缩图片、优化代码和 DEX 文件，可以显著减小 APK 大小。开启 Proguard 混淆、使用 WebP 格式图片、去除多余的架构 `so` 文件等方式，能帮助开发者优化应用的包体积。

同时，利用 Android App Bundles 和动态特性模块可以为用户提供更加灵活、高效的应用下载体验。

希望这篇文章能对你在优化 APK 包体积时有所帮助，进一步提高应用的性能和用户体验。

* * *

这样，这篇文章就完成了！你可以根据需要调整文章的格式和内容，或者根据实际情况添加更多的优化技巧。如果有其他问题，随时告诉我！
